<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Formulario √önico de Solicitud - P√°gina 2</title>
  <link rel="stylesheet" href="/styleform.css">
</head>
<body>
  <div class="container">

    <form method="POST" action="/guardar">
  <!-- Campos ocultos para datos de la p√°gina 1 -->
  <% if (typeof data !== 'undefined') { %>
    <% Object.keys(data).forEach(key => { %>
      <input type="hidden" name="<%= key %>" value="<%= data[key] %>">
    <% }) %>
  <% } %>

  <!-- Campos ocultos adicionales -->
  <input type="hidden" name="usuario" value="<%= data.usuario || '' %>">
  <input type="hidden" name="fechaHoraLocal" id="fechaHoraLocal">

  <fieldset>
    <legend>Datos del titular del asiento</legend>

    <label>Tipo de Documento de Identificaci√≥n:</label>
    <% const docTitularVal = data.docTitular || ''; %>
    <input type="radio" id="duiTitularRadio" name="docTitular" value="DUI" <%= docTitularVal === 'DUI' ? 'checked' : '' %>> DUI
    <input type="radio" id="nuiTitularRadio" name="docTitular" value="NUI" <%= docTitularVal === 'NUI' ? 'checked' : '' %>> NUI
    <input type="radio" id="otroTitularRadio" name="docTitular" value="Otro" <%= docTitularVal === 'Otro' ? 'checked' : '' %>> Otro

    <div id="campoDUI_Titular" style="display:none;">
      <label>N√∫mero de DUI:</label>
      <input type="text" id="duiTitularInput" name="duiTitular" value="<%= data.duiTitular || '' %>">
    </div>

    <div id="campoNUI_Titular" style="display:none;">
      <label>N√∫mero de NUI:</label>
      <input type="text" id="nuiTitularInput" name="nuiTitular" value="<%= data.nuiTitular || '' %>">
    </div>

    <div id="campoOtro_Titular" style="display:none;">
      <label>Especifique otro documento:</label>
      <input type="text" id="otroTitularInput" name="otroTitular" value="<%= data.otroTitular || '' %>">
    </div>
  </fieldset>

  <label>Nombre:</label><br>
  <input type="text" name="primerNombreTitular" value="<%= data.primerNombreTitular || '' %>" placeholder="Primer Nombre">
  <input type="text" name="segundoNombreTitular" value="<%= data.segundoNombreTitular || '' %>" placeholder="Segundo Nombre">
  <input type="text" name="primerApellidoTitular" value="<%= data.primerApellidoTitular || '' %>" placeholder="Primer Apellido">
  <input type="text" name="segundoApellidoTitular" value="<%= data.segundoApellidoTitular || '' %>" placeholder="Segundo Apellido">
  <button type="button" id="btnTercerApellidoTitular">+ A√±adir Tercer Apellido</button>
  <input type="text" name="tercerApellidoTitular" id="tercerApellidoTitular" value="<%= data.tercerApellidoTitular || '' %>" placeholder="Tercer Apellido" style="display:none;">

  <label>Fecha del hecho o acto jur√≠dico:</label>
  <input type="date" name="fechaHecho" value="<%= data.fechaHecho || '' %>">

  <label>Lugar del hecho o acto jur√≠dico:</label>
  <input type="text" id="lugarHecho" name="lugarHecho" value="<%= data.lugarHecho || '' %>">

  <fieldset>
    <legend>Nombre de la madre</legend>
    <input type="text" name="primerNombreMadre" value="<%= data.primerNombreMadre || '' %>" placeholder="Primer Nombre">
    <input type="text" name="segundoNombreMadre" value="<%= data.segundoNombreMadre || '' %>" placeholder="Segundo Nombre">
    <input type="text" name="primerApellidoMadre" value="<%= data.primerApellidoMadre || '' %>" placeholder="Primer Apellido">
    <input type="text" name="segundoApellidoMadre" value="<%= data.segundoApellidoMadre || '' %>" placeholder="Segundo Apellido">
    <input type="text" name="tercerApellidoMadre" value="<%= data.tercerApellidoMadre || '' %>" placeholder="Tercer Apellido (opcional)">
  </fieldset>

  <fieldset>
    <legend>Nombre del padre</legend>
    <input type="text" name="primerNombrePadre" value="<%= data.primerNombrePadre || '' %>" placeholder="Primer Nombre">
    <input type="text" name="segundoNombrePadre" value="<%= data.segundoNombrePadre || '' %>" placeholder="Segundo Nombre">
    <input type="text" name="primerApellidoPadre" value="<%= data.primerApellidoPadre || '' %>" placeholder="Primer Apellido">
    <input type="text" name="segundoApellidoPadre" value="<%= data.segundoApellidoPadre || '' %>" placeholder="Segundo Apellido">
  </fieldset>

  <fieldset>
    <legend>Declaraci√≥n de la solicitud</legend>
    <% const declaracionVal = data.declaracion || ''; %>
    <label><input type="radio" name="declaracion" value="Nacimiento" <%= declaracionVal === 'Nacimiento' ? 'checked' : '' %>> Nacimiento</label>
    <label><input type="radio" name="declaracion" value="Matrimonio" <%= declaracionVal === 'Matrimonio' ? 'checked' : '' %>> Matrimonio</label>
    <label><input type="radio" name="declaracion" value="Union" <%= declaracionVal === 'Union' ? 'checked' : '' %>> Uni√≥n no matrimonial</label>
  </fieldset>

  <fieldset>
    <legend>Descripci√≥n de la Documentaci√≥n Presentada</legend>
    <% const docItems = [ "Defunci√≥n en", "Registro de Defunci√≥n Fetal", "Estado Familiar adquirido en el extranjero",
      "Nacimiento en el extranjero", "Reposici√≥n", "Anotaciones Marginales", "Cancelaci√≥n",
      "Modificaciones", "Acta de reconocimiento", "Resoluci√≥n Sustitutiva del R√©gimen Patrimonial",
      "Rectificaciones", "Subsanaciones", "Anotaciones a un asiento posterior", "Otros" ]; %>
    <% const docVal = Array.isArray(data.doc) ? data.doc : []; %>
    <% docItems.forEach(item => { %>
      <label><input type="checkbox" name="doc[]" value="<%= item %>" <%= docVal.includes(item) ? 'checked' : '' %>> <%= item %></label>
    <% }) %>

    <hr>

    <% const doc2Items = [ "Fecha M√©dica de Nacimiento", "Testimonio de Escritura P√∫blica", "Certificaci√≥n de Sentencia Ejecutoriada",
      "Certificaci√≥n de L√≠nea Legal", "Certificado M√©dico de Defunci√≥n", "Autorizaci√≥n de juez",
      "Hecho en extranjero", "Resoluci√≥n Administrativa", "Resoluci√≥n Judicial" ]; %>
    <% const doc2Val = Array.isArray(data.doc2) ? data.doc2 : []; %>
    <% doc2Items.forEach(item => { %>
      <label><input type="checkbox" name="doc2[]" value="<%= item %>" <%= doc2Val.includes(item) ? 'checked' : '' %>> <%= item %></label>
    <% }) %>
  </fieldset>

  <div class="botones-finales">
  <!-- Bot√≥n regresar en rojo -->
  <a href="/formulario" class="btn-rojo">‚Üê Regresar</a>

  <% if (modoEdicion) { %>
    <!-- Bot√≥n guardar cambios en verde -->
    <button type="submit" formaction="/actualizar" class="btn-verde">
      Guardar cambios
    </button>
  <% } %>

  <!-- Bot√≥n enviar en verde -->
  <button type="submit" formaction="/guardar" class="btn-verde">
    Enviar
  </button>
</div>
</form>

 <script src="https://unpkg.com/imask"></script>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const $ = (id) => document.getElementById(id);

    // --- Mostrar campos seg√∫n tipo de documento del titular ---
    function activarOpciones(radioName, map) {
      const radios = document.getElementsByName(radioName);
      radios.forEach(radio => {
        radio.addEventListener("change", () => {
          for (const key in map) {
            const cfg = map[key];
            const cont = $(cfg.contenedor);
            const input = $(cfg.input);
            const radioElem = $(cfg.radio);
            if (cont && input && radioElem) {
              const activo = radioElem.checked;
              cont.style.display = activo ? "block" : "none";
              input.disabled = !activo;
              if (!activo) input.value = "";
            }
          }
        });
      });
    }

    activarOpciones("docTitular", {
      duiT: { radio: "duiTitularRadio", contenedor: "campoDUI_Titular", input: "duiTitularInput" },
      nuiT: { radio: "nuiTitularRadio", contenedor: "campoNUI_Titular", input: "nuiTitularInput" },
      otroT: { radio: "otroTitularRadio", contenedor: "campoOtro_Titular", input: "otroTitularInput" }
    });

    // Ejecutar al cargar para mostrar el campo activo
    ["duiTitularRadio", "nuiTitularRadio", "otroTitularRadio"].forEach(id => {
      const radio = document.getElementById(id);
      if (radio && radio.checked) radio.dispatchEvent(new Event("change"));
    });

    // --- Capturar hora local del navegador ---
    const fechaHoraLocalInput = document.getElementById("fechaHoraLocal");
    if (fechaHoraLocalInput) {
      fechaHoraLocalInput.value = new Date().toISOString();
    }

    // --- Mostrar campo de tercer apellido del titular ---
    const btnTercerApellidoTitular = document.getElementById("btnTercerApellidoTitular");
    const tercerApellidoTitular = document.getElementById("tercerApellidoTitular");
    if (btnTercerApellidoTitular && tercerApellidoTitular) {
      btnTercerApellidoTitular.addEventListener("click", () => {
        tercerApellidoTitular.style.display = "inline-block";
        btnTercerApellidoTitular.style.display = "none";
      });
    }

    // --- M√°scara DUI ---
    const duiInput = document.getElementById("duiTitularInput");
    let duiMask;
    if (duiInput) {
      duiMask = IMask(duiInput, {
        mask: '00000000-0'
      });
    }

    // --- Validaci√≥n manual al enviar ---
    const form = document.querySelector("form");
    form.addEventListener("submit", (e) => {
      console.log("üöÄ Evento submit disparado, enviando formulario...");
      const nombre = document.querySelector("[name='primerNombreTitular']");
      const apellido = document.querySelector("[name='primerApellidoTitular']");
      if (!nombre.value.trim() || !apellido.value.trim()) {
        e.preventDefault();
        alert("Debe completar al menos el primer nombre y primer apellido del titular.");
        nombre.focus();
        return;
      }

      // Validar DUI si est√° seleccionado
      const duiRadio = document.getElementById("duiTitularRadio");
      if (duiRadio && duiRadio.checked) {
        const valorDUI = duiInput.value.trim();
        const patronDUI = /^\d{8}-\d$/;
        if (!patronDUI.test(valorDUI)) {
          e.preventDefault();
          alert("El n√∫mero de DUI debe tener el formato 00000000-0.");
          duiInput.focus();
        }
      }
    });

    // --- Autocompletar lugar seg√∫n la declaraci√≥n seleccionada ---
    const lugarHechoInput = document.getElementById("lugarHecho");
    const declaracionRadios = document.querySelectorAll("input[name='declaracion']");

    function actualizarLugarHecho() {
      const seleccion = document.querySelector("input[name='declaracion']:checked");
      if (seleccion) {
        switch (seleccion.value) {
          case "Nacimiento":
            lugarHechoInput.value = "Hospital / Cl√≠nica / Domicilio";
            break;
          case "Matrimonio":
            lugarHechoInput.value = "Alcald√≠a / Iglesia / Juzgado / Notar√≠a";
            break;
          case "Union":
            lugarHechoInput.value = "Alcald√≠a / Juzgado";
            break;
          default:
            lugarHechoInput.value = "";
        }
      } else {
        lugarHechoInput.value = "";
      }
    }

    declaracionRadios.forEach(radio => {
      radio.addEventListener("change", actualizarLugarHecho);
    });

    actualizarLugarHecho();
  });
</script>

</body>
</html>
