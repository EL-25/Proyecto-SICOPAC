<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <title>Formulario Único de Solicitud - Página 1</title>
  <link rel="stylesheet" href="/styleform.css">
</head>

<body>
  <div class="container">

    <!-- Encabezado institucional -->
    <header class="encabezado-formulario">
      <img src="/img/LogoAlcaldia.png" alt="Logo institucional" class="logo-esquina">
    </header>

    <!-- Título principal -->
    <h2 class="titulo-formulario">FORMULARIO ÚNICO DE SOLICITUD</h2>

    <form method="post"> 
      <!-- Campos ocultos para datos de la página 2 -->
       <% if (typeof data !== 'undefined') { %>
        <% Object.keys(data).forEach(key => {
          if (key !== 'codigoFormulario') { %>
            <input type="hidden" name="<%= key %>" value="<%= data[key] %>">
        <% } }) %>
       <% } %>
  
      <p>Código del formulario:
        <input type="text" name="codigoFormulario" value="<%= data.codigoFormulario || '' %>" readonly>
      </p>

      <div class="encabezado">
        <p>No. de Presentación REF/LLE:
          <input type="date" id="refLLE" name="refLLE" value="<%= data.refLLE || '' %>">
        </p>

        <label for="municipio">Municipio:</label>
        <input type="text" id="municipio" name="municipio" value="<%= data.municipio || 'La Libertad Este' %>" readonly>

        <label for="distrito">Distrito:</label>
        <% const distritoVal = data.distrito || ''; %>
        <select id="distrito" name="distrito" required>
          <option value="Antiguo Cuscatlán" <%= distritoVal === 'Antiguo Cuscatlán' ? 'selected' : '' %>>Antiguo Cuscatlán</option>
          <option value="Nuevo Cuscatlán" <%= distritoVal === 'Nuevo Cuscatlán' ? 'selected' : '' %>>Nuevo Cuscatlán</option>
          <option value="San José Villanueva" <%= distritoVal === 'San José Villanueva' ? 'selected' : '' %>>San José Villanueva</option>
          <option value="Huizúcar" <%= distritoVal === 'Huizúcar' ? 'selected' : '' %>>Huizúcar</option>
          <option value="Zaragoza" <%= distritoVal === 'Zaragoza' ? 'selected' : '' %>>Zaragoza</option>
        </select>
        
        <p>Lugar de presentación:
          <input type="text" id="lugarPresentacion" name="lugarPresentacion" value="<%= data.lugarPresentacion || '' %>">
        </p>

        <p>
          Fecha de presentación:
          <input type="date" id="fechaPresentacion" name="fechaPresentacion" value="<%= data.fechaPresentacion || '' %>">
          Hora:
          <input type="time" id="horaPresentacion" name="horaPresentacion" value="<%= data.horaPresentacion || '' %>">
        </p>

        <p>Contacto para consultar estado de trámite:
          <input type="text" name="contacto" value="<%= data.contacto || '' %>">
        </p>

        <p>Plazo de respuesta:
          <input type="text" name="plazo" value="<%= data.plazo || '' %>">
        </p>
      </div>

      <hr><br>

      <label>Tipo de Documento de Identificación:</label>
      <% const docTipoVal = data.docTipo || ''; %>
      <input type="radio" name="docTipo" value="DUI" id="duiRadio" <%= docTipoVal === 'DUI' ? 'checked' : '' %>> DUI
      <input type="radio" name="docTipo" value="Pasaporte" id="pasaporteRadio" <%= docTipoVal === 'Pasaporte' ? 'checked' : '' %>> Pasaporte
      <input type="radio" name="docTipo" value="Otro" id="otroRadio" <%= docTipoVal === 'Otro' ? 'checked' : '' %>> Otro

      <div id="campoDUI" style="display:none;">
        <label>Número de DUI:</label>
        <input type="text" id="duiInput" name="dui" value="<%= data.dui || '' %>">
      </div>

      <div id="campoPasaporte" style="display:none;">
        <label>Número de Pasaporte:</label>
        <input type="text" id="pasaporteInput" name="pasaporte" value="<%= data.pasaporte || '' %>">
      </div>

      <div id="campoOtro" style="display:none;">
        <label>Especifique otro documento:</label>
        <input type="text" id="otroInput" name="otroDoc" value="<%= data.otroDoc || '' %>">
      </div>

            <br><br>

      <label>Nombre:</label>
      <div class="fila-nombre">
        <div>
          <label for="primerNombre">Primer Nombre:</label>
          <input type="text" name="primerNombre" id="primerNombre" value="<%= data.primerNombre || '' %>" required>
        </div>
        <div>
          <label for="segundoNombre">Segundo Nombre:</label>
          <input type="text" name="segundoNombre" id="segundoNombre" value="<%= data.segundoNombre || '' %>">
        </div>
        <div>
          <label for="primerApellido">Primer Apellido:</label>
          <input type="text" name="primerApellido" id="primerApellido" value="<%= data.primerApellido || '' %>" required>
        </div>
        <div>
          <label for="segundoApellido">Segundo Apellido:</label>
          <input type="text" name="segundoApellido" id="segundoApellido" value="<%= data.segundoApellido || '' %>">
          <button type="button" class="btn-tercer-apellido-mini" onclick="document.getElementById('tercerApellidoContainer').style.display='block'; this.style.display='none';">
      + Tercer Apellido
    </button>
  </div>
</div>

<div id="tercerApellidoContainer" style="display: none;">
  <label for="tercerApellido">Tercer Apellido (solo si aplica):</label>
  <input type="text" name="tercerApellido" id="tercerApellido" value="<%= data.tercerApellido || '' %>">
</div>

<label>Domicilio:</label>
<% const cantonVal = data.canton || ''; %>
<div class="fila-domicilio">
  <div>
    <label for="canton">Cantón:</label>
    <select name="canton" id="canton">
      <option value="">Seleccione</option>
      <option value="Ojos de Agua" <%= cantonVal === 'Ojos de Agua' ? 'selected' : '' %>>Ojos de Agua</option>
      <option value="Jiñuco" <%= cantonVal === 'Jiñuco' ? 'selected' : '' %>>Jiñuco</option>
      <option value="Madrecacao" <%= cantonVal === 'Madrecacao' ? 'selected' : '' %>>Madrecacao</option>
      <option value="La Palma" <%= cantonVal === 'La Palma' ? 'selected' : '' %>>La Palma</option>
      <option value="Los Naranjos" <%= cantonVal === 'Los Naranjos' ? 'selected' : '' %>>Los Naranjos</option>
      <option value="El Carrizal" <%= cantonVal === 'El Carrizal' ? 'selected' : '' %>>El Carrizal</option>
      <option value="Cujuapa" <%= cantonVal === 'Cujuapa' ? 'selected' : '' %>>Cujuapa</option>
    </select>
  </div>
  <div>
    <label for="calle">Calle o Pasaje:</label>
    <input type="text" name="calle" id="calle" value="<%= data.calle || '' %>" placeholder="Ej. Pasaje El Triunfo">
  </div>
  <div>
    <label for="colonia">Colonia / Barrio:</label>
    <input type="text" name="colonia" id="colonia" value="<%= data.colonia || '' %>" placeholder="Ej. Santa Marta">
  </div>
  <div>
    <label for="numeroCasa">Número de casa:</label>
    <input type="text" name="numeroCasa" id="numeroCasa" value="<%= data.numeroCasa || '' %>" placeholder="Ej. #23">
  </div>
</div>

            <label>¿Es el mismo titular del asiento?</label>
      <% const titularVal = data.titular || ''; %>
      <input type="radio" name="titular" value="Sí" <%= titularVal === 'Sí' ? 'checked' : '' %>> Sí
      <input type="radio" name="titular" value="No" <%= titularVal === 'No' ? 'checked' : '' %>> No
      <br><br>

      <label>Carácter en que comparece:</label>
      <% const caracterVal = Array.isArray(data.caracter) ? data.caracter : (typeof data.caracter === 'string' ? data.caracter.split(',') : []); %>
      <input type="checkbox" name="caracter" value="Informante" <%= caracterVal.includes('Informante') ? 'checked' : '' %>> Informante
      <input type="checkbox" name="caracter" value="Padre" <%= caracterVal.includes('Padre') ? 'checked' : '' %>> Padre
      <input type="checkbox" name="caracter" value="Madre" <%= caracterVal.includes('Madre') ? 'checked' : '' %>> Madre
      <input type="checkbox" name="caracter" value="Responsable" <%= caracterVal.includes('Responsable') ? 'checked' : '' %>> Responsable
      <br><br>

      <label>Teléfono:</label>
      <input type="tel" id="telefono" name="telefono" value="<%= data.telefono || '' %>" maxlength="9" placeholder="0000-0000" required>
      <br><br>

      <label>Correo electrónico:</label>
      <input type="email" name="correo" value="<%= data.correo || '' %>" required>
      <br><br>

      <div class="botones-finales">
        <% if (modo === "editar") { %>
          <button type="submit" formaction="/editar-formulario-p2">Siguiente →</button>
        <% } else { %>
          <button type="submit" formaction="/page2">Siguiente →</button>
        <% } %>

        <!-- Botón Home -->
        <button type="button" 
          onclick="window.location.href='mis-datos.html'" 
          class="btn-home">
          Home
        </button>
      </div>
    </form>
  </div>

  <!-- Scripts -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const $ = (id) => document.getElementById(id);
      const fechaInput = $("fechaPresentacion");
      const horaInput = $("horaPresentacion");
      const refLLEInput = $("refLLE");

      function setFechaHora() {
        const ahora = new Date();
        const año = ahora.getFullYear();
        const mes = String(ahora.getMonth() + 1).padStart(2, '0');
        const dia = String(ahora.getDate()).padStart(2, '0');
        const fechaStr = `${año}-${mes}-${dia}`;
        if (fechaInput && !fechaInput.value) fechaInput.value = fechaStr;
        if (refLLEInput && !refLLEInput.value) refLLEInput.value = fechaStr;
        actualizarHora();
      }

      function actualizarHora() {
        const ahora = new Date();
        const h = String(ahora.getHours()).padStart(2, '0');
        const m = String(ahora.getMinutes()).padStart(2, '0');
        if (horaInput && !horaInput.value) horaInput.value = `${h}:${m}`;
      }

      setFechaHora();
      setInterval(actualizarHora, 60000);

      const distritoSelect = $("distrito");
      const lugarInput = $("lugarPresentacion");
      if (distritoSelect && lugarInput && !lugarInput.value) {
        lugarInput.value = `${distritoSelect.value} - La Libertad Este`;
      }
      distritoSelect.addEventListener("change", () => {
        lugarInput.value = `${distritoSelect.value} - La Libertad Este`;
      });

      function activarOpciones(radioName, map) {
        const radios = document.getElementsByName(radioName);
        radios.forEach(radio => {
          radio.addEventListener("change", () => {
            for (const key in map) {
              const cfg = map[key];
              const cont = $(cfg.contenedor);
              const input = $(cfg.input);
              const radioElem = $(cfg.radio);
              if (cont && input && radioElem) {
                const activo = radioElem.checked;
                cont.style.display = activo ? "block" : "none";
                input.disabled = !activo;
                if (!activo) input.value = "";
              }
            }
          });
        });
      }

      activarOpciones("docTipo", {
        dui: { radio: "duiRadio", contenedor: "campoDUI", input: "duiInput" },
        pas: { radio: "pasaporteRadio", contenedor: "campoPasaporte", input: "pasaporteInput" },
        otro: { radio: "otroRadio", contenedor: "campoOtro", input: "otroInput" }
      });
    });
  </script>

  <script>
    const cantonSeleccionado = "<%= typeof canton !== 'undefined' ? canton : '' %>";
    document.addEventListener("DOMContentLoaded", () => {
      const distritoSelect = document.getElementById("distrito");
      const cantonSelect = document.getElementById("canton");
      const coloniaInput = document.getElementById("colonia");

      const opciones = {
        "Antiguo Cuscatlán": { cantones: ["Ojos de Agua","Jiñuco","Madrecacao","La Palma","Los Naranjos","El Carrizal","Cujuapa"], colonias: ["San Juan","San José","Santa Lucía","Concepción","San Nicolás","El Calvario","El Centro"] },
        "Nuevo Cuscatlán": { cantones: [], colonias: ["San Juan","San José","Santa Lucía","Concepción","San Nicolás","El Calvario","El Centro"] },
        "San José Villanueva": { cantones: ["Las Dispensas","El Palomar","El Espíritu","Tula","El Matazano"], colonias: [] },
        "Zaragoza": { cantones: ["El Barillo","Guadalupe","San Francisco","San Sebastián"], colonias: [] },
        "Huizúcar": { cantones: ["Analquito","La Lima","Nazareth","Ojos de Agua","San Juan Buenavista","Tilaza"], colonias: [] }
      };

      function actualizarOpciones() {
        const distrito = distritoSelect.value;
        const data = opciones[distrito] || { cantones: [], colonias: [] };
        cantonSelect.innerHTML = "<option value=''>Seleccione</option>";
        data.cantones.forEach(c => {
          const opt = document.createElement("option");
          opt.value = c;
          opt.textContent = c;
          if (cantonSeleccionado === c) opt.selected = true;
          cantonSelect.appendChild(opt);
        });
        if (data.colonias.length > 0) {
          coloniaInput.setAttribute("list", "coloniasList");
          let datalist = document.getElementById("coloniasList");
          if (!datalist) {
            datalist = document.createElement("datalist");
            datalist.id = "coloniasList";
            document.body.appendChild(datalist);
          }
          datalist.innerHTML = "";
          data.colonias.forEach(col => {
            const opt = document.createElement("option");
            opt.value = col;
            datalist.appendChild(opt);
          });
        } else {
          coloniaInput.removeAttribute("list");
        }
      }

      distritoSelect.addEventListener("change", actualizarOpciones);
      actualizarOpciones();
    });
  </script>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const telefonoInput = document.getElementById("telefono");
      const form = document.querySelector("form");
      telefonoInput.addEventListener("input", (e) => {
        let valor = e.target.value.replace(/\D/g, "");
        if (valor.length > 4) {
          valor = valor.slice(0, 4) + "-" + valor.slice(4, 8);
        }
        e.target.value = valor;
      });
      form.addEventListener("submit", (e) => {
        const regex = /^\d{4}-\d{4}$/;
        if (!regex.test(telefonoInput.value)) {
          e.preventDefault();
          alert("El teléfono debe tener el formato 0000-0000");
          telefonoInput.focus();
        }
      });
    });
  </script>

    <script>
    document.addEventListener("DOMContentLoaded", () => {
      const codigoInput = document.querySelector("input[name='codigoFormulario']");
      if (codigoInput && !codigoInput.value) {
        fetch("/api/nuevo-codigo")
          .then(res => res.json())
          .then(data => {
            codigoInput.value = data.codigo;
          })
          .catch(err => console.error("Error al obtener código:", err));
      }
    });
  </script>

</body>
</html>
